<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACW Offerteplatform</title>
  <!-- Inter overal; Rajdhani voor prijzen/headers/voorblad -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{ --acw-red:#D52B1E; --acw-black:#222222 }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: 'Inter', system-ui, sans-serif; background:#f7f7f8; color:#111 }
    header{ background:#222; color:#fff; border-bottom:4px solid var(--acw-red) }
    .head{ display:flex; gap:12px; align-items:center; padding:12px 16px }
    .head img{ height:36px }
    .head h1{ margin:0; font-size:18px; font-weight:800 }

    .container{ max-width:1060px; margin:18px auto; padding:0 14px }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 2px 12px rgba(0,0,0,.05); padding:18px; margin-bottom:14px }
    .title{ font-size:18px; font-weight:800; margin:0 0 8px }
    .muted{ color:#6b7280; font-size:14px }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:760px){ .row{ grid-template-columns:1fr } }
    label{ display:block; font-weight:700; margin:8px 0 4px }
    input,select,textarea{ width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:16px; background:#fff }
    textarea{ resize:vertical }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:none; cursor:pointer; font-weight:800; background:var(--acw-red); color:#fff; border-radius:12px }
    .btn:disabled{ opacity:0.5; cursor:not-allowed }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{ border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; cursor:pointer; user-select:none }
    .chip.active{ border-color:var(--acw-red); color:var(--acw-red); font-weight:700 }
    .hidden{ display:none }

    /* Currency with € prefix */
    .currency{ position:relative }
    .currency .prefix{ position:absolute; left:10px; top:50%; transform:translateY(-50%); pointer-events:none; color:#111 }
    .currency input{ padding-left:28px }

    /* Papier / letter pagina's */
    .letter{ width:210mm; min-height:297mm; background:#fff; margin:0 auto; position:relative; box-shadow:0 2px 12px rgba(0,0,0,.05); font-size:10pt; line-height:1.5 }
    .letter-bg{ position:absolute; inset:0; background-size:cover; background-position:center; opacity:1 }
    .letter-body{ position:relative; padding:28mm 22mm 24mm 22mm; font-size:10pt; line-height:1.5 }
    .letter .meta{ margin:0 0 14px; font-size:10pt }
    .signature{ margin-top:18px }
    .signature img{ max-height:100px; display:block }

    /* Prijzenoverzicht */
    .pricesheet-body{ font-family:'Rajdhani', sans-serif; font-weight:500; font-size:10pt }
    table.pricetable{ width:100%; border-collapse:separate; border-spacing:0; font-size:10pt; font-family:'Rajdhani', sans-serif }
    table.pricetable th, table.pricetable td{ padding:8px 10px; border-bottom:1px solid #e5e7eb; text-align:left }
    table.pricetable th{ background:var(--acw-red); color:#fff; font-weight:700 }
    table.pricetable td.bold{ font-weight:700 }
    table.pricetable tfoot td{ font-weight:700 }

    /* Toelichting */
    .raj-title{ font-family:'Rajdhani', sans-serif; font-weight:700 }
    .acw-ul{ list-style:none; padding-left:0; margin:8px 0 0 }
    .acw-ul li{ position:relative; padding-left:20px; margin:6px 0; font-size:10pt }
    .acw-ul li::before{ content:'•'; position:absolute; left:0; top:0.2em; font-size:14px; color:var(--acw-red); }

    .note{ padding:10px 12px; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:10px; font-size:14px }
    .ok{ color:#065f46; background:#ecfdf5; border-color:#a7f3d0 }
    .notes-input{ display:flex; gap:8px; align-items:center }
    .note-add{ width:38px; height:38px; border-radius:10px; border:none; background:var(--acw-red); color:#fff; font-weight:800; font-size:20px; cursor:pointer; line-height:0 }
    .notes-list{ margin-top:10px }
    .notes-list .item{ display:flex; align-items:flex-start; gap:8px; margin:6px 0; font-size:10pt }
    .notes-list .remove{ background:none; border:none; color:#b91c1c; font-size:18px; cursor:pointer; line-height:1 }

    /* Ondertekenen blok */
    .sign-title{ margin-top:24px; margin-bottom:10px; font-size:10pt }
    .sign-grid{ display:flex; gap:24px; align-items:flex-start }
    .sign-grid > div{ flex:1 }
    .sign-left img{ height:100px; display:block; margin-bottom:8px }
    .sign-right{ margin-top:108px }
    .sign-line{ border-top:2px solid #000; width:220px; margin-bottom:8px }
    .sign-text{ font-size:10pt; line-height:1.3 }

    /* Voorblad */
    .cover-body{ font-family:'Rajdhani', sans-serif; color:#fff; font-size:10pt; font-weight:500 }
    .cover-photo{ position:absolute; inset:0; background-size:cover; background-position:center }
    .cover-overlay{ position:absolute; inset:0; background:url('https://www.acwbv.nl/wp-content/uploads/2025/08/Voorblad-template.png') center/cover no-repeat }
    /* Tekst exact in het rode vlak positioneren obv 1241x1756, x=45px, y=1120px (projectafspraak) */
    .cover-text{ position:absolute; top:190mm; left:28mm; width:90mm; display:flex; justify-content:space-between; gap:1px; }
    .cover-col{ width:48%; }
    .cover-col p{ margin:3px 0 }
    .cover-col .label{ font-weight:700 }

    /* Export helper (onzichtbaar) */
    .export-stack{ position:fixed; left:-99999px; top:-99999px; width:200mm }
    .page-break{ page-break-after:always }
  </style>
</head>
<body>
  <header>
    <div class="head">
      <img src="https://www.acwbv.nl/wp-content/uploads/2025/08/LOGO-ACW-RGB-SLOGAN-DIAP-OP-ZWART.png" alt="ACW logo">
      <h1>Offerteplatform</h1>
    </div>
  </header>

  <main class="container">
    <!-- TYPE -->
    <section class="card" id="typeSection">
      <h2 class="title">Stap 0 – Kies offertetype</h2>
      <div class="chips" id="typeChips">
        <div class="chip" data-kind="regular_office">Reguliere schoonmaak kantoren</div>
        <div class="chip" data-kind="regular_hoa">Reguliere schoonmaak VvE's</div>
        <div class="chip" data-kind="specialist">Specialistische reiniging</div>
        <div class="chip" data-kind="glass">Glasbewassing</div>
      </div>
      <p class="muted" id="typeLabel">Nog geen type gekozen.</p>
      <div class="actions" style="margin-top:12px">
        <button id="btnStart" class="btn" disabled>Start met invullen</button>
      </div>
    </section>

    <!-- FORM PAGES WRAPPER -->
    <section id="formPage" class="hidden">
      <!-- BASIS -->
      <section class="card" id="basisSection">
        <h2 class="title">1) Basisgegevens</h2>
        <h3 class="title" style="font-size:16px">Interne gegevens</h3>
        <div class="row">
          <div>
            <label>Naam offertemaker *</label>
            <select id="makerName">
              <option value="" selected>Kies...</option>
              <option value="Roger van den Donker" data-abbr="rd">Roger van den Donker (rd)</option>
              <option value="Jaimy van Pelt" data-abbr="jvp">Jaimy van Pelt (jvp)</option>
              <option value="Daniël van Pelt" data-abbr="dvp">Daniël van Pelt (dvp)</option>
            </select>
          </div>
          <div>
            <label>Afkorting offertemaker *</label>
            <input id="makerAbbr" placeholder="rd / jvp / dvp" readonly>
          </div>
          <div>
            <label>Offertenummer Nocore *</label>
            <input id="nocoreNumber" placeholder="Bijv. 12345">
          </div>
        </div>

        <h3 class="title" style="font-size:16px;margin-top:14px">NAW-gegevens klant</h3>
        <div class="row">
          <div><label>Naam bedrijf *</label><input id="companyName" placeholder="Bedrijfsnaam"></div>
          <div><label>Naam contactpersoon *</label><input id="contactFull" placeholder="Voornaam Achternaam"></div>
          <div><label>Voornaam contactpersoon</label><input id="contactFirst" placeholder="Wordt automatisch bepaald" readonly></div>
          <div><label>Straat + huisnummer *</label><input id="street" placeholder="Straat 1"></div>
          <div><label>Postcode + plaats *</label><input id="postalCity" placeholder="1234 AB, Plaats"></div>
        </div>

        <h3 class="title" style="font-size:16px;margin-top:14px">Gegevens voorbrief</h3>
        <div class="row">
          <div>
            <label>Datum *</label>
            <input id="letterDate" type="date">
          </div>
          <div>
            <label>Onze referentie</label>
            <input id="ourRef" placeholder="Wordt automatisch gegenereerd" readonly>
            <div class="muted">Formaat: &lt;bedrijf&gt;-acw-&lt;afkorting&gt;-&lt;nocore nr&gt;</div>
          </div>
        </div>
      </section>

      <!-- VOORBRIEF INVOER -->
      <section class="card" id="voorbriefSection">
        <h2 class="title">2) Voorbrief – invoer</h2>
        <label>Betreft *</label>
        <input id="letterSubject" placeholder="Bijv. Offerte reguliere schoonmaak">
        <label>Inhoud *</label>
        <textarea id="letterBody" rows="8" placeholder="Schrijf hier de inhoud van de brief..."></textarea>
        <div class="actions" style="margin-top:10px"><button id="btnUpdatePreview" class="btn">Voorbeeld bijwerken</button></div>
      </section>

      <!-- VOORBRIEF PREVIEW -->
      <section class="card" id="letterSection">
        <h2 class="title">3) Voorbeeld voorbrief</h2>
        <div class="letter"><div class="letter-bg" id="letterBg"></div><div class="letter-body" id="letterContent"></div></div>
        <div class="actions" style="margin-top:10px"><button id="btnApproveLetter" class="btn">Goedkeuren en doorgaan</button></div>
        <div id="approveNote" class="note ok hidden">Voorbrief is goedgekeurd. Je kunt doorgaan naar de volgende stap.</div>
      </section>

      <!-- PRIJZEN INVOER -->
      <section class="card" id="pricingSection">
        <h2 class="title">4) Prijzen – invoer</h2>
        <p class="muted" id="pricingIntro">Type: <span id="pricingType">-</span></p>
        <div id="pricingFields" class="row"></div>
        <div class="actions" style="margin-top:10px"><button id="btnUpdatePricePreview" class="btn">Voorbeeld bijwerken</button></div>
      </section>

      <!-- PRIJZENOVERZICHT PREVIEW -->
      <section class="card" id="pricesheetSection">
        <h2 class="title">5) Prijzenoverzicht – voorbeeld</h2>
        <div class="letter"><div class="letter-bg" id="priceBg"></div><div class="letter-body pricesheet-body" id="priceContent"></div></div>
      </section>

      <!-- TOELICHTING INVOER -->
      <section class="card" id="notesInputSection">
        <h2 class="title">6) Aandachtspunten/toelichting – invoer</h2>
        <p class="muted">Voeg hier eventuele <strong>Bijzonderheden</strong> toe. Laat leeg als er geen bijzonderheden zijn.</p>
        <div class="notes-input">
          <input id="noteInput" placeholder="Bijzonderheid toevoegen..." />
          <button id="addNote" class="note-add" title="Toevoegen">+</button>
        </div>
        <div id="notesList" class="notes-list"></div>
        <div class="actions" style="margin-top:10px"><button id="btnUpdateNotesPreview" class="btn">Voorbeeld bijwerken</button></div>
      </section>

      <!-- TOELICHTING PREVIEW -->
      <section class="card" id="notesPreviewSection">
        <h2 class="title">7) Aandachtspunten/toelichting – voorbeeld</h2>
        <div class="letter"><div class="letter-bg" id="notesBg"></div><div class="letter-body" id="notesContent"></div></div>
      </section>

      <!-- VOORBLAD INVOER -->
      <section class="card" id="coverInputSection">
        <h2 class="title">8) Voorblad – invoer</h2>
        <div class="row">
          <div>
            <label>Beknopte samenvatting *</label>
            <input id="coverSummary" placeholder="Bijv. Voorstel reguliere schoonmaak diensten">
          </div>
          <div>
            <label>Afbeelding *</label>
            <select id="coverImageChoice">
              <option value="standard">Standaard afbeelding</option>
              <option value="custom">Eigen afbeelding uploaden</option>
            </select>
            <input type="file" id="coverImageUpload" class="hidden" accept="image/*">
          </div>
        </div>
        <div class="actions" style="margin-top:10px"><button id="btnUpdateCoverPreview" class="btn">Voorbeeld bijwerken</button></div>
      </section>

      <!-- VOORBLAD PREVIEW -->
      <section class="card" id="coverPreviewSection">
        <h2 class="title">9) Voorblad – voorbeeld</h2>
        <div class="letter">
          <div class="letter-bg cover-photo" id="coverBg"></div>
          <div class="cover-overlay"></div>
          <div class="cover-body">
            <div class="cover-text">
            <div class="cover-col" id="coverLeft" data-print-lock="left"></div>
            <div class="cover-col" id="coverRight" data-print-lock="right"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- EXPORT -->
      <section class="card" id="exportSection">
        <h2 class="title">10) Exporteren</h2>
        <p class="muted">Exporteer alles naar <strong>één PDF</strong> in de volgorde: Voorblad → Voorbrief → Prijzenoverzicht → Toelichting</p>
        <button class="btn" id="btnExportPdf">Exporteren als PDF</button>
        <div id="exportToast" class="note ok hidden" style="margin-top:10px">PDF wordt gegenereerd…</div>
      </section>

      <!-- DIAGNOSE / TESTS -->
      <section class="card" id="diagnoseSection">
        <h2 class="title">Diagnose (zelftest)</h2>
        <button class="btn" id="btnSelfTest">Zelftest uitvoeren</button>
        <div id="selfTestOut" class="muted" style="margin-top:8px"></div>
      </section>

    </section>

    <!-- Verborgen container voor export -->
    <div id="exportStack" class="export-stack"></div>
  </main>

  <!-- PROBEER CDN LADEN (non-blocking); als dit faalt, gebruiken we print-fallback -->
  <script>
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=src; s.async=true; s.onload=()=>resolve(true); s.onerror=()=>reject(new Error('load failed:'+src));
        document.head.appendChild(s);
      });
    }
    async function ensureHtml2Pdf(){
      if(window.html2pdf) return true;
      const cdns=[
        'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js'
      ];
      for(const url of cdns){
        try{ await loadScript(url); if(window.html2pdf) return true; }catch(e){ /* try next */ }
      }
      return !!window.html2pdf;
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const el=id=>document.getElementById(id);
      const labels={regular_office:'Reguliere schoonmaak kantoren', regular_hoa:"Reguliere schoonmaak VvE's", specialist:'Specialistische reiniging', glass:'Glasbewassing'};
      const DRAFT=window.DRAFT||{ kind:null, meta:{}, pricing:{}, notes:[] }; window.DRAFT=DRAFT;

      // Utils
      const euro=n=>`€ ${Number(n||0).toLocaleString('nl-NL',{minimumFractionDigits:2, maximumFractionDigits:2})}`;
      const formatDateDMY=iso=>{ if(!iso) return ''; const [y,m,d]=iso.split('-'); return `${d}-${m}-${y}`; };
      const deriveFirstName=full=>{ const t=(full||'').trim(); const idx=t.indexOf(' '); return idx>-1?t.slice(0,idx):t; };
      const esc=s=>(s||'').replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
      const nl2br=s=>esc(s).replace(/\n/g,'<br>');
      const getBgUrl=(el)=>{ if(!el) return ''; const bi=getComputedStyle(el).backgroundImage; const m=/url\(["']?(.*?)["']?\)/.exec(bi||''); return m?m[1]:''; };

      // TYPE chips
      document.querySelectorAll('#typeChips .chip').forEach(ch=>ch.addEventListener('click',()=>{
        document.querySelectorAll('#typeChips .chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        DRAFT.kind=ch.getAttribute('data-kind');
        el('typeLabel').textContent=`Gekozen: ${labels[DRAFT.kind]||''}`;
        el('btnStart').disabled=false;
      }));

      // Start flow
      el('btnStart').addEventListener('click',()=>{
        if(!DRAFT.kind){ alert('Kies eerst een offertetype.'); return; }
        el('typeSection').classList.add('hidden');
        el('formPage').classList.remove('hidden');
        el('pricingType').textContent=labels[DRAFT.kind]||'-';
        renderPricingFields();
        const today=new Date();
        const iso=new Date(today.getTime()-today.getTimezoneOffset()*60000).toISOString().slice(0,10);
        el('letterDate').value=iso; DRAFT.meta.letterDate=iso;
      });

      // Basis events
      el('makerName').addEventListener('change',e=>{const abbr=e.target.selectedOptions[0]?.getAttribute('data-abbr')||''; el('makerAbbr').value=abbr; DRAFT.meta.makerName=e.target.value; DRAFT.meta.makerAbbr=abbr; updateRef();});
      el('nocoreNumber').addEventListener('input',()=>{DRAFT.meta.nocoreNumber=el('nocoreNumber').value; updateRef();});
      el('companyName').addEventListener('input',()=>{DRAFT.meta.companyName=el('companyName').value; updateRef();});
      el('contactFull').addEventListener('input',()=>{DRAFT.meta.contactFull=el('contactFull').value; DRAFT.meta.contactFirst=deriveFirstName(DRAFT.meta.contactFull); el('contactFirst').value=DRAFT.meta.contactFirst;});
      el('street').addEventListener('input',()=>{DRAFT.meta.street=el('street').value;});
      el('postalCity').addEventListener('input',()=>{DRAFT.meta.postalCity=el('postalCity').value;});
      el('letterDate').addEventListener('input',()=>{DRAFT.meta.letterDate=el('letterDate').value;});
      function updateRef(){ const m=DRAFT.meta; const c=m.companyName?.trim(); const a=m.makerAbbr?.trim(); const n=m.nocoreNumber?.trim(); el('ourRef').value=(c&&a&&n)?`${c}-acw-${a}-${n}`:''; m.ourRef=el('ourRef').value; }

      // Voorbrief preview
      el('btnUpdatePreview').addEventListener('click',()=>{
        const m=DRAFT.meta, subject=el('letterSubject').value, body=el('letterBody').value;
        const roles={ 'Jaimy van Pelt':'Sales & Bedrijfsbureau','Daniël van Pelt':'Directeur','Roger van den Donker':'Directeur' };
        const sigs={ rd:'https://www.acwbv.nl/wp-content/uploads/2025/08/handtekening-roger.png', jvp:'https://www.acwbv.nl/wp-content/uploads/2025/08/handtekening-jaimy.png', dvp:'https://www.acwbv.nl/wp-content/uploads/2025/08/handtekening-daniel.png' };
        const sig=sigs[m.makerAbbr]||''; const role=roles[m.makerName]||'';

        let html='';
        html+=`<div class=\"meta\" style=\"text-align:right; margin-top:10px\">Datum: ${formatDateDMY(m.letterDate||'')}</div><br>`;
        html+=`<strong>${esc(m.companyName||'')}</strong><br><strong>T.a.v. ${esc(m.contactFull||'')}</strong><br><strong>${esc(m.street||'')}</strong><br><strong>${esc(m.postalCity||'')}</strong><br><br>`;
        html+=`<em>Onze referentie: ${esc(m.ourRef||'')}</em><br><em>Betreft: ${esc(subject||'')}</em><br><br>`;
        html+=`Beste ${esc(m.contactFirst||'')},<br><br>${nl2br(body||'')}<br><br>`;
        html+=`<div class=\"signature\">Met vriendelijke groet,<br><br>${sig?`<img src=\"${sig}\" style=\"height:100px\" alt=\"Handtekening\"><br>`:''}ACW<br>${esc(m.makerName||'')}<br><em>${esc(role)}</em></div>`;

        el('letterContent').innerHTML=html;
        el('letterBg').style.backgroundImage="url('https://www.acwbv.nl/wp-content/uploads/2025/08/Briefpapier_Schoonmaak_2024-1_page-0001.jpg')";
        document.getElementById('letterSection').scrollIntoView({behavior:'smooth'});
      });
      el('btnApproveLetter').addEventListener('click',()=>{ el('approveNote').classList.remove('hidden'); document.getElementById('pricingSection').scrollIntoView({behavior:'smooth'}); });

      // Pricing fields
      function renderPricingFields(){
        const wrap=el('pricingFields'); wrap.innerHTML=''; let html='';
        if(DRAFT.kind==='regular_office'||DRAFT.kind==='regular_hoa'){
          html+=`<div class=\"currency\"><label>Prijs *</label><span class=\"prefix\">€</span><input id=\"price\" inputmode=\"decimal\" placeholder=\"0,00\"></div>`;
          html+=`<div><label>Facturatieschema *</label><select id=\"billing\"><option value=\"\">Kies...</option><option value=\"maand\">Per maand</option><option value=\"4w\">Per periode (4 weken)</option></select></div>`;
          html+=`<div><label>Hoogste frequentie *</label><select id=\"highFreq\"><option value=\"\">Kies...</option><option>5x per week</option><option>4x per week</option><option>3x per week</option><option>2x per week</option><option>1x per week</option><option>1x per maand</option></select></div>`;
        } else if(DRAFT.kind==='specialist'){
          html+=`<div class=\"currency\"><label>Prijs (per beurt) *</label><span class=\"prefix\">€</span><input id=\"price\" inputmode=\"decimal\" placeholder=\"0,00\"></div>`;
          html+=`<div><label>Facturatie</label><input value=\"Per beurt\" readonly></div>`;
        } else if(DRAFT.kind==='glass'){
          html+=`<div class=\"currency\"><label>Prijs (per beurt) *</label><span class=\"prefix\">€</span><input id=\"price\" inputmode=\"decimal\" placeholder=\"0,00\"></div>`;
          html+=`<div><label>Frequentie (per jaar) *</label><input id=\"freq\" type=\"number\" min=\"1\" step=\"1\" placeholder=\"Bijv. 4\"></div>`;
          html+=`<div><label>Prijs per jaar</label><input id=\"yearly\" readonly></div>`;
        }
        wrap.innerHTML=html;

        const price=el('price'), billing=el('billing'), freq=el('freq'), yearly=el('yearly'), highFreq=el('highFreq');
        const parseDec=v=> Number(String(v).replace(/\./g,'').replace(',','.'));
        function sync(){
          if(price) DRAFT.pricing.price = parseDec(price.value||0) || 0;
          if(billing) DRAFT.pricing.billing = billing.value||'';
          if(freq) DRAFT.pricing.frequency = Number(freq.value||0);
          if(highFreq) DRAFT.pricing.highFreq = highFreq.value||'';
          if(yearly && DRAFT.kind==='glass'){
            const y=(DRAFT.pricing.price||0)*(DRAFT.pricing.frequency||0);
            yearly.value=euro(y); DRAFT.pricing.yearly=y;
          }
        }
        price && price.addEventListener('input',sync);
        billing && billing.addEventListener('change',sync);
        freq && freq.addEventListener('input',sync);
        highFreq && highFreq.addEventListener('change',sync);
        sync();
      }

      // Prijzenoverzicht preview
      el('btnUpdatePricePreview').addEventListener('click',()=>{
        if(!DRAFT.kind){ alert('Kies eerst een offertetype.'); return; }
        if((DRAFT.kind==='regular_office'||DRAFT.kind==='regular_hoa')){
          if(!(DRAFT.pricing.price>0)){ alert('Vul een geldige prijs in.'); return; }
          if(!DRAFT.pricing.billing){ alert('Kies een facturatieschema.'); return; }
          if(!DRAFT.pricing.highFreq){ alert('Kies de hoogste frequentie.'); return; }
        }
        if(DRAFT.kind==='specialist' && !(DRAFT.pricing.price>0)){ alert('Vul een geldige prijs in.'); return; }
        if(DRAFT.kind==='glass'){
          if(!(DRAFT.pricing.price>0)){ alert('Vul een geldige prijs in.'); return; }
          if(!(DRAFT.pricing.frequency>0)){ alert('Vul een geldige frequentie per jaar in.'); return; }
        }

        const m=DRAFT.meta, p=DRAFT.pricing; const rows=[];
        if(DRAFT.kind==='regular_office'||DRAFT.kind==='regular_hoa'){
          rows.push(['Hoogste frequentie', p.highFreq||'-']);
          rows.push(['Facturatieschema', p.billing==='maand'?'Per maand':'Per periode (4 weken)']);
          const prijsLabel=p.billing==='maand'?'Prijs per maand':'Prijs per periode';
          rows.push([prijsLabel, euro(p.price)]);
        } else if(DRAFT.kind==='specialist'){
          rows.push(['Prijs (per beurt)', euro(p.price)]);
        } else if(DRAFT.kind==='glass'){
          rows.push(['Frequentie (per jaar)', p.frequency]);
          rows.push(['Prijs per beurt', euro(p.price)]);
          rows.push(['Prijs per jaar', euro((p.price||0)*(p.frequency||0))]);
        }

        let html='';
        html+=`<div class=\"meta\" style=\"text-align:right; margin-top:10px\">Datum: ${formatDateDMY(m.letterDate||'')}</div><br>`;
        html+=`<strong>${esc(m.companyName||'')}</strong><br><strong>T.a.v. ${esc(m.contactFull||'')}</strong><br><strong>${esc(m.street||'')}</strong><br><strong>${esc(m.postalCity||'')}</strong><br><br>`;
        html+=`<h1 class=\"raj-title\" style=\"font-size:16pt; margin:0 0 10px\">Prijzenoverzicht</h1>`;
        html+=`<table class=\"pricetable\">`;
        html+=`<thead><tr><th>Omschrijving</th><th>Waarde</th></tr></thead><tbody>`;
        rows.forEach(([label,val])=>{
          const isPrice=/^Prijs/i.test(label);
          html+=`<tr><td class=\"${isPrice?'bold':''}\">${esc(label)}</td><td class=\"${isPrice?'bold':''}\">${typeof val==='string'?esc(val):val}</td></tr>`;
        });
        html+=`</tbody>`;
        if(DRAFT.kind==='glass'){
          html+=`<tfoot><tr><td>Totaal per jaar</td><td>${euro((p.price||0)*(p.frequency||0))}</td></tr></tfoot>`;
        }
        html+=`</table>`;

        el('priceContent').innerHTML=html;
        el('priceBg').style.backgroundImage="url('https://www.acwbv.nl/wp-content/uploads/2025/08/Briefpapier-overige-pagina-1.jpg')";
        document.getElementById('pricesheetSection').scrollIntoView({behavior:'smooth'});
      });

      // Toelichting vaste punten
      const GENERAL_NOTES=[
        'Genoemde bedragen en tarieven zijn exclusief het geldende BTW percentage en gebaseerd op een gehele gunning en de aangegeven handelingen en frequenties alsmede de bruto-uurlonen conform de CAO voor Schoonmaak- en Glazenwassersbedrijf 2025.',
        'Op deze offerte zijn de algemene voorwaarden van onze brancheorganisatie (Schoonmakend Nederland) van toepassing. Deze kunt u vinden op onze website.',
        'Alle rechten zijn voorbehouden. Niets van de in deze offerte gepubliceerde gegevens mag worden verveelvoudigd, opgeslagen in een geautomatiseerd gegevensbestand en/of openbaar worden gemaakt, in enige vorm of op enige wijze, hetzij elektronisch, mechanisch, door fotokopieën, opnamen of enige andere manier, zonder uitdrukkelijke voorafgaande schriftelijke toestemming van ACW. Ook het gebruik van merk- en productnamen van ACW in op zoekmachines gerichte teksten is niet toegestaan. ACW hanteert een actief en strikt beleid in de controle van ongevraagde verveelvoudiging of misbruik van materialen en teksten van haar website en zal bij overtreding altijd juridische stappen nemen.',
        'De betaling van de facturen met een beurtprijs geschiedt achteraf en dient binnen dertig dagen na factuurdatum te zijn voldaan.',
        'De betaling van de facturen met een periodeprijs (per 4 weken) geschiedt vooraf en dient binnen dertig dagen na factuurdatum te zijn voldaan.',
        'De offerte is geldig tot 60 dagen na dagtekening.',
        'Levering geschiedt volgens de algemene voorwaarden van Schoonmakend Nederland.',
        'Het karakter van dit voorstel is vrijblijvend.'
      ];

      // Bijzonderheden UI
      function renderNotesList(){
        const list=el('notesList');
        if(!DRAFT.notes.length){ list.innerHTML='<div class="muted">(Nog geen bijzonderheden toegevoegd)</div>'; return; }
        list.innerHTML='';
        DRAFT.notes.forEach((t,idx)=>{
          const row=document.createElement('div'); row.className='item';
          row.innerHTML=`<img src='https://www.acwbv.nl/wp-content/uploads/2025/08/Bulletpoint-ACW.png' alt='' style='width:12px;height:12px;margin-top:6px'> <div style='flex:1'>${esc(t)}</div> <button class='remove' title='Verwijderen'>&times;</button>`;
          row.querySelector('.remove').addEventListener('click',()=>{ DRAFT.notes.splice(idx,1); renderNotesList(); });
          list.appendChild(row);
        });
      }
      el('addNote').addEventListener('click',()=>{ const v=(el('noteInput').value||'').trim(); if(!v) return; DRAFT.notes.push(v); el('noteInput').value=''; renderNotesList(); });

      // Toelichting preview + ondertekenen
      function buildNotesPreview(){
        const m=DRAFT.meta;
        let html='';
        html+=`<h1 class=\"raj-title\" style=\"font-size:16pt; margin:0 0 10px\">Aandachtspunten/toelichting</h1>`;
        html+=`<h2 class=\"raj-title\" style=\"font-size:13pt; margin:10px 0 6px\">Algemeen</h2>`;
        html+=`<ul class=\"acw-ul\">${GENERAL_NOTES.map(n=>`<li>${esc(n)}</li>`).join('')}</ul>`;
        if(DRAFT.notes.length){
          html+=`<h2 class=\"raj-title\" style=\"font-size:13pt; margin:16px 0 6px\">Bijzonderheden</h2>`;
          html+=`<ul class=\"acw-ul\">${DRAFT.notes.map(n=>`<li>${esc(n)}</li>`).join('')}</ul>`;
        }
        const sigs={ rd:'https://www.acwbv.nl/wp-content/uploads/2025/08/handtekening-roger.png', jvp:'https://www.acwbv.nl/wp-content/uploads/2025/08/handtekening-jaimy.png', dvp:'https://www.acwbv.nl/wp-content/uploads/2025/08/handtekening-daniel.png' };
        const sig=sigs[m.makerAbbr]||'';
        html+=`<div class="sign-title">Voor akkoord:</div>`;
        html+=`<div class="sign-grid signature-row">`;
        html+=`  <div class="sign-left signature-col">`+
        `${sig?`<img src="${sig}" alt="Handtekening">`:''}`+
        `<div class="sign-text">ACW<br>${esc(m.makerName||'')}</div>`+
      `</div>`;
        html+=`  <div class="sign-right signature-col">`+
        `<div class="sign-line signature-line"></div>`+
        `<div class="sign-text">${esc(m.companyName||'')}<br>${esc(m.contactFull||'')}</div>`+
      `</div>`;
        html+=`</div>`;

        el('notesContent').innerHTML=html;
        el('notesBg').style.backgroundImage = "url('https://www.acwbv.nl/wp-content/uploads/2025/08/Briefpapier-overige-pagina-1.jpg')";
        document.getElementById('notesPreviewSection').scrollIntoView({behavior:'smooth'});
      }
      el('btnUpdateNotesPreview').addEventListener('click',buildNotesPreview);

      // === VOORBLAD ===
      el('coverImageChoice').addEventListener('change',()=>{
        if(el('coverImageChoice').value==='custom') el('coverImageUpload').classList.remove('hidden');
        else { el('coverImageUpload').classList.add('hidden'); el('coverImageUpload').value=''; }
      });

      function resolveStandardCover(kind){
        if(kind==='regular_office'||kind==='regular_hoa') return 'https://www.acwbv.nl/wp-content/uploads/2025/08/Foto-schoonmaak.png';
        if(kind==='specialist') return 'https://www.acwbv.nl/wp-content/uploads/2025/08/Foto-specialistische-reiniging.jpg';
        if(kind==='glass') return 'https://www.acwbv.nl/wp-content/uploads/2025/08/Foto-glasbewassing.jpg';
        return '';
      }

      function updateCoverPreview(){
        const m=DRAFT.meta;
        const summary=(el('coverSummary').value||'').trim();
        const left=`<p class=\"label\">Voorstel t.b.v.:</p>`+
          `<p>${esc(m.companyName||'')}</p>`+
          `<p>${esc(m.street||'')}</p>`+
          `<p>${esc(m.postalCity||'')}</p>`;
        const right=`<p class=\"label\">Voorstel m.b.t.:</p>`+
          `<p>${esc(summary)}</p>`;
        el('coverLeft').innerHTML=left;
        el('coverRight').innerHTML=right;

        const choice=el('coverImageChoice').value;
        if(choice==='custom'){
          const file=el('coverImageUpload').files?.[0];
          if(file){
            const reader=new FileReader();
            reader.onload=e=>{ el('coverBg').style.backgroundImage=`url('${e.target.result}')`; };
            reader.readAsDataURL(file);
          } else {
            const url=resolveStandardCover(DRAFT.kind); el('coverBg').style.backgroundImage=url?`url('${url}')`:'';
          }
        } else {
          const url=resolveStandardCover(DRAFT.kind); el('coverBg').style.backgroundImage=url?`url('${url}')`:'';
        }
      }

      el('btnUpdateCoverPreview').addEventListener('click',()=>{ updateCoverPreview(); document.getElementById('coverPreviewSection').scrollIntoView({behavior:'smooth'}); });

      // ===== EXPORT HELPERS =====
      const assetCache={};
      async function toDataUrl(url){
        if(assetCache[url]) return assetCache[url];
        const res=await fetch(url);
        const blob=await res.blob();
        const data=await new Promise(r=>{const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob);});
        assetCache[url]=data; return data;
      }
      async function inlineAssets(node){
        for(const cls of ['.letter-bg','.cover-photo','.cover-overlay']){
          for(const el of node.querySelectorAll(cls)){
            const url=getBgUrl(el); if(!url) continue;
            try{ el.style.backgroundImage=`url('${await toDataUrl(url)}')`; }catch(e){/* ignore */}
          }
        }
        for(const img of node.querySelectorAll('img')){
          const src=img.getAttribute('src');
          if(src && !src.startsWith('data:')){
            try{ img.src=await toDataUrl(src); }catch(e){/* ignore */}
          }
        }
        const bp=await toDataUrl('https://www.acwbv.nl/wp-content/uploads/2025/08/Bulletpoint-ACW.png');
        node.querySelectorAll('.acw-ul').forEach(ul=>{
          ul.style.listStyle='none';
          ul.style.paddingLeft='0';
          ul.style.margin='8px 0 0';
        });
        node.querySelectorAll('.acw-ul li').forEach(li=>{
          li.style.listStyle='none';
          li.style.position='relative';
          li.style.paddingLeft='20px';
          li.style.margin='6px 0';
          li.style.fontSize='10pt';
          li.style.backgroundImage=`url('${bp}')`;
          li.style.backgroundRepeat='no-repeat';
          li.style.backgroundPosition='0 0.95em';
          li.style.backgroundSize='11px 11px';
        });
      }
      async function clonePage(elm){
        const node=elm.cloneNode(true);
        node.querySelectorAll('.letter-bg').forEach(bg=>{
          const cs=getComputedStyle(bg);
          bg.style.backgroundImage=cs.backgroundImage;
          bg.style.backgroundSize=cs.backgroundSize;
          bg.style.backgroundPosition=cs.backgroundPosition;
        });
        await inlineAssets(node);
        node.classList.add('page-break');
        return node;
      }
      async function buildExportStack(){
        const stack=document.getElementById('exportStack');
        stack.innerHTML='';
        const order=['coverPreviewSection','letterSection','pricesheetSection','notesPreviewSection'];
        for(const id of order){
          const sec=document.getElementById(id); if(!sec) continue; const page=sec.querySelector('.letter'); if(page) stack.appendChild(await clonePage(page));
        }
        return stack;
      }

      function collectPages(){
        const order=['coverPreviewSection','letterSection','pricesheetSection','notesPreviewSection'];
        const pages=[];
        order.forEach(id=>{
          const sec=document.getElementById(id); if(!sec) return; const page=sec.querySelector('.letter'); if(!page) return;
          if(id==='coverPreviewSection'){
            pages.push({ type:'cover', photoUrl:getBgUrl(page.querySelector('.cover-photo')), overlayUrl:getBgUrl(page.querySelector('.cover-overlay')), bodyHTML: page.querySelector('.cover-body')?.innerHTML||'' });
          } else {
            pages.push({ type:'letter', bgUrl:getBgUrl(page.querySelector('.letter-bg')), bodyHTML: page.querySelector('.letter-body')?.innerHTML||'' });
          }
        });
        return pages;
      }

      async function printFallback(){
        const toast=el('exportToast');
        toast.classList.remove('hidden'); toast.textContent='PDF (print) wordt voorbereid…';
        const pages=collectPages();
        const iframe=document.createElement('iframe');
        iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
        document.body.appendChild(iframe);
        const doc=iframe.contentDocument || iframe.contentWindow.document;
        doc.open();
        doc.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>ACW-offerte</title>
          <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
          <style>
            @page { size: A4 portrait; margin: 0; }
            html,body{ margin:0; padding:0; background:#fff }
            @media print{
            *{ -webkit-print-color-adjust: exact; print-color-adjust: exact }
            }
            .page{ width:210mm; height:297mm; position:relative; page-break-after:always; overflow:hidden; font-family:'Inter',sans-serif; }
            .bg-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }
            .body{ position:relative; padding:28mm 22mm 24mm 22mm; font-size:10pt; line-height:1.5 }
            .cover-body{ position:relative; font-family:'Rajdhani', sans-serif; font-weight:500; color:#fff; }
            .cover-text{ position:absolute; top:197mm; left:28mm; width:90mm; display:flex; justify-content:space-between; gap:1px; }
            .cover-col{ width:48% }
            .cover-col p{ margin:3px 0 }
            .cover-col .label{ font-weight:700 }
            .raj-title{ font-family:'Rajdhani', sans-serif; font-weight:700 }
            table.pricetable{ width:100%; border-collapse:separate; border-spacing:0; font-size:10pt; font-family:'Rajdhani', sans-serif }
            table.pricetable th, table.pricetable td{ padding:8px 10px; border-bottom:1px solid #e5e7eb; text-align:left }
            table.pricetable th{ background:#D52B1E; color:#fff; font-weight:700 }
            table.pricetable td.bold{ font-weight:700 }
            .acw-ul{ list-style:none; padding-left:0; margin:8px 0 0 }
            .acw-ul li{ position:relative; padding-left:20px; margin:6px 0; font-size:10pt }
            .acw-ul li::before{ content:'•'; position:absolute; left:0; top:0.2em; font-size:14px; color:#D52B1E; }
            .sign-title{ margin-top:24px; margin-bottom:10px; font-size:10pt }
            .sign-left img{ height:100px; display:block; margin-bottom:8px }
            .sign-right{ margin-top:108px }
            .sign-line{ border-top:2px solid #000; width:220px; margin-bottom:8px }
            .sign-text{ font-size:10pt; line-height:1.3 }
          /* === PRINT STABILITY RULES (voorblad + ondertekenen) === */
@media print{
/* 1) Cover: twee tekstvakken als stabiele inline‑blocks met vaste kolombreedtes */
[data-print-lock]{
display:inline-block; /* stabieler dan flex/grid in print */
vertical-align:top;
width:48%;
box-sizing:border-box;
page-break-inside: avoid;
}
[data-print-lock="left"]{ margin-right:4%; }
[data-print-lock] *{ line-height:1.25; } /* vaste line-height voorkomt reflow per pagina */


/* 2) Ondertekenen: vaste kolommen, geen wrap/glitches */
.signature-row{ display:flex; page-break-inside: avoid; align-items:flex-start; }
.signature-col{ flex:0 0 48%; box-sizing:border-box; }
.signature-col + .signature-col{ margin-left:4%; }


.signature-line{ height:0; border-top:2px solid #000; margin:12px 0 8px; }
.keep-inline{ display:inline-block; vertical-align:middle; }


/* 3) Breek‑beheersing zodat blokken niet door midden scheuren */
.page h2, .page h3, .page p, .signature-row, [data-print-lock]{
orphans:3; widows:3; /* nettere tekst */
break-inside: avoid; /* moderne syntax */
page-break-inside: avoid; /* legacy */
}


/* 4) Font & metrieken consistent houden in print */
body{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
}          
          </style></head><body>`);
        pages.forEach(p=>{
          doc.write('<div class="page">');
          if(p.bgUrl) doc.write(`<img class="bg-img" src="${p.bgUrl}">`);
          if(p.photoUrl) doc.write(`<img class="bg-img" src="${p.photoUrl}">`);
          if(p.overlayUrl) doc.write(`<img class="bg-img" src="${p.overlayUrl}">`);
          doc.write(`<div class="${p.type==='cover'?'cover-body':'body'}">${p.bodyHTML}</div>`);
          doc.write('</div>');
        });
        doc.write('</body></html>');
        doc.close();
        // wacht tot alle afbeeldingen geladen zijn
        const imgs=doc.images; const waitImgs=Array.from(imgs).map(img=> new Promise(res=>{ if(img.complete) return res(); img.onload=img.onerror=()=>res(); }));
        await Promise.all(waitImgs);
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        setTimeout(()=>{ document.body.removeChild(iframe); toast.textContent='Printdialoog geopend. Kies "Opslaan als PDF".'; setTimeout(()=>toast.classList.add('hidden'), 4000); }, 500);
      }

// ===== EXPORT (PDF) – raster via html2canvas =====
async function exportPdfRaster(){
  await ensureRasterLibs();
  const stack = await buildExportStack();
  const pdf = new jspdf.jsPDF({orientation:'p', unit:'mm', format:'a4'});
  const w = pdf.internal.pageSize.getWidth();
  const h = pdf.internal.pageSize.getHeight();
  const pages = Array.from(stack.children);
  for(let i=0; i<pages.length; i++){
    const canvas = await html2canvas(pages[i], {scale:2, useCORS:true, backgroundColor:'#fff'});
    const img = canvas.toDataURL('image/jpeg', 0.95);
    if(i>0) pdf.addPage();
    pdf.addImage(img, 'JPEG', 0, 0, w, h);
  }
  pdf.save('offerte.pdf');
  stack.innerHTML = '';
}

document.getElementById('btnExportPdf').addEventListener('click', async function(){
  const toast = el('exportToast');
  toast.classList.remove('hidden');
  toast.textContent = 'PDF wordt gegenereerd…';
  try{
    await exportPdfRaster();
    toast.textContent = 'PDF download gestart';
  }catch(err){
    console.error(err);
    await printFallback();
    return;
  }
  setTimeout(()=>toast.classList.add('hidden'), 4000);
});

      async function ensureRasterLibs(){
// Wacht totdat window.html2canvas en window.jspdf geladen zijn
const wait = (cond)=> new Promise(r=>{
const t=setInterval(()=>{ if(cond()){ clearInterval(t); r(); } }, 50);
});
if(!window.html2canvas){ await wait(()=>window.html2canvas); }
if(!(window.jspdf && window.jspdf.jsPDF)){ await wait(()=>window.jspdf && window.jspdf.jsPDF); }
return true;
}
      // ===== Zelftest =====
      el('btnSelfTest').addEventListener('click', async ()=>{
        const out=el('selfTestOut');
        function ok(b){return b? '✅' : '❌'}
        const pages=['coverPreviewSection','letterSection','pricesheetSection','notesPreviewSection'].map(id=>({id, has: !!document.getElementById(id)?.querySelector('.letter')}));
        const h2p = !!window.html2pdf || await ensureHtml2Pdf();
        out.innerHTML = [
          `html2pdf beschikbaar: ${ok(h2p)}`,
          ...pages.map(p=>`Sectie ${p.id}: ${ok(p.has)}`)
        ].join('<br>');
      });
    });
  </script>
</body>
</html>
 
